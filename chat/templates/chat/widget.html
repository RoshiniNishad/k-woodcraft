<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
  /* Floating Chat Button */
  .kwc-chat-btn {
    position: fixed; right: 20px; bottom: 20px; z-index: 9999;
    border: 0; border-radius: 50%; padding: 16px;
    background: #198754; color: #fff; font-size: 22px;
    box-shadow: 0 10px 25px rgba(0,0,0,.2);
    transition: transform 0.3s ease, background 0.3s ease;
  }
  .kwc-chat-btn:hover {
    transform: scale(1.1);
    background: #157347;
  }

  /* Chat Window */
  .kwc-chat-window {
    position: fixed; right: 20px; bottom: 80px; z-index: 9999;
    width: 340px; max-height: 70vh; display: none; flex-direction: column;
    background: #fff; border-radius: 16px; 
    box-shadow: 0 15px 35px rgba(0,0,0,.25); 
    overflow: hidden; animation: fadeInUp 0.3s ease;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .kwc-chat-header {
    background: #198754; color: #fff; padding: 12px 14px;
    font-weight: 600; display: flex; justify-content: space-between;
    align-items: center; font-size: 1rem;
  }
  .kwc-chat-header button {
    background: transparent; border: none; color: #fff;
    font-size: 20px; line-height: 1;
  }

  .kwc-chat-body {
    padding: 12px; overflow-y: auto; height: 320px; font-size: 0.9rem;
    background: #f9f9f9;
  }

  .kwc-chat-input {
    display: flex; gap: 6px; padding: 10px; border-top: 1px solid #eee; background: #fff;
  }
  .kwc-chat-input input {
    border-radius: 12px; font-size: 0.9rem;
  }
  .kwc-chat-input button {
    border-radius: 12px; padding: 6px 14px;
  }

  .kwc-bubble {
    padding: 10px 12px; border-radius: 14px; margin: 6px 0; max-width: 80%;
    font-size: 0.9rem; line-height: 1.4;
  }
  .kwc-bot {
    background: #e9f7fe; color: #055160; align-self: flex-start;
  }
  .kwc-user {
    background: #dcfce7; color: #065f46; align-self: flex-end;
  }
</style>

<!-- Chat Button -->
<button class="kwc-chat-btn" id="kwcToggleChat">
  <i class="fas fa-robot"></i>
</button>

<!-- Chat Window -->
<div class="kwc-chat-window" id="kwcChat">
  <div class="kwc-chat-header">
    <span><i class="fas fa-headset me-2"></i> Support</span>
    <button id="kwcCloseChat"><i class="fas fa-times"></i></button>
  </div>
  <div class="kwc-chat-body d-flex flex-column" id="kwcBody">
    <div class="kwc-bubble kwc-bot">👋 Hi! How can I help you today?</div>
  </div>
  <div class="kwc-chat-input">
    <input id="kwcInput" class="form-control" placeholder="Type your message…" />
    <button id="kwcSend" class="btn btn-success">Send</button>
  </div>
</div>

<script>
(function(){
  const toggleBtn = document.getElementById("kwcToggleChat");
  const closeBtn  = document.getElementById("kwcCloseChat");
  const win       = document.getElementById("kwcChat");
  const body      = document.getElementById("kwcBody");
  const input     = document.getElementById("kwcInput");
  const sendBtn   = document.getElementById("kwcSend");

  function bubble(text, who) {
    const div = document.createElement("div");
    div.className = "kwc-bubble " + (who === "user" ? "kwc-user" : "kwc-bot");
    div.textContent = text;
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
  }
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  async function ask() {
    const text = (input.value || "").trim();
    if (!text) return;
    bubble(text, "user");
    input.value = "";
    try {
      const res = await fetch("{% url 'chat_api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({message: text})
      });
      const data = await res.json();
      bubble(data.reply || "⚠️ Sorry, something went wrong.", "bot");
    } catch(e) {
      bubble("⚠️ Network error, please try again.", "bot");
    }
  }

  // Toggle chat (open/close with button)
  toggleBtn.addEventListener("click", () => {
    if (win.style.display === "flex") {
      win.style.display = "none";
    } else {
      win.style.display = "flex";
    }
  });
  closeBtn.addEventListener("click", () => win.style.display = "none");

  sendBtn.addEventListener("click", ask);
  input.addEventListener("keydown", e => { if (e.key === "Enter") ask(); });
})();
</script>
